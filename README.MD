# Start SYMFONY
[![PHP 8.1](https://img.shields.io/badge/php-8.1-%23777BB4?style=for-the-badge&logo=php&logoColor=black">)](https://www.php.net/releases/7_4_0.php)
[![MariaDB 10.3](https://img.shields.io/badge/MariaDB-10.3-003545?style=for-the-badge&logo=mariadb&logoColor=white)](https://mariadb.com/kb/en/mariadb-10332-release-notes/)
[![Nginx 1.17](https://img.shields.io/badge/nginx-1.17-%23009639.svg?style=for-the-badge&logo=nginx&logoColor=white)](https://nginx.org/en/CHANGES-1.18)
[![Symfony 6.0](https://img.shields.io/badge/symfony-6.0-%23000000.svg?style=for-the-badge&logo=symfony&logoColor=white)](https://symfony.com/doc/5.3)
[![Yarn](https://img.shields.io/badge/yarn-%232C8EBB.svg?style=for-the-badge&logo=yarn&logoColor=white)](https://www.npmjs.com/package/yarn/v/1.22.5)

## :heavy_check_mark: c чего начать

1) [x] в корневом .env указать переменную APP_NAME с названием проекта
2) [ ] в папке docker-compose указать свободные порты для контейнеров nginx db и mailer (перехватчик писем)
3) [ ] в .env.local указать перехватчик писем ```MAILER_DSN=smtp://mailer:1025``` и другие переменные, которые относятся 
к локальной среде разработки. 
    - [ ] потом на http://localhost:1055 можно смотреть перехватываемые письма.

### Переменные проекта
Переменные проекта заданы в файле /project/.env . Это основной файл, который должен содержать все переменные, даже если 
какая-то переменная нужна только на тесте, она всё равно должна быть указана в .env
Так как /project/.env находится в git - это лучшее место для хранения *универсальных* настроек нужных для разработки

Файл .env.local нужен для хранения локальных изменений, специфичных для окружения. Идеально подходит для:
- Определения настроек для разворачивания проекта на сервере, как стейджинг, так и прод. Для этого вручную создается 
в папке /project на сервере
- Определения локальных или временных настроек необходимых для разработки проекта, без необходимости передавать эти 
параметры в git 

> Файлы локальных переменных .env.local добавлены в гитигнор, так и должно быть. Symfony использует эти файлы для настройки
локальных переменных при работе локально через докер или при выгрузке на прод или стейджинг сервер. Переменные в этих файлах 
на проде, стейджинге и при локальной разработке, как правило, отличаются.  

## Развернуть локально в Docker :heavy_check_mark:
Развернуть на локальной машине:
1) [x] Перейти в папку проекта и запустить "make init"
2) [ ] запустить миграции (``make app-migrations``)
3) [ ] накатить фикстуры (``make app-php-cli-bash`` -> ``symfony console d:f:l``)
    - login : (``your_email@project.com``)
    - pass : (``your_password``)

Сайт доступен на http://localhost:8055 \
Адрес для входа в админку http://localhost:8055/admin (``пока не реализовано!``)

## Makefile
Все необходимые команды прописаны в Makefile (нужно в него зайти и посмотреть)
Например:
Запуск webpack в dev режиме
```make yarn-watch```

## Развернуть на сервере прод/стейджинг

### Первичная конфигурация - делаем один раз

Для поднятия проекта на сервере прописаны команды в Makefile, коорые делают то, что в нормальном продакшене
делает CI/CD. Для их корректной работы нужны указать версию PHP в переменной PROD_PHP. \
vendor и ассеты фронта исключены с гита и поэтому собираются с помощью комманд CLI.При первом разворачивании проекта на 
сервере нужно выполнить следующую последовательность операций:

1) ```git push``` изменений в ветку main, master или release
2) ```git pull``` в папке на сервере из ветки, в которую спушили
3) прописать переменные характерные для серверного окружения в .env.local
4) в файле Makefile указать в переменной PROD_PHP путь до нужной версии PHP на сервере
5) запустить композер инстал, установить миграции, и собрать ассеты для фронта ```make prod-build```

### Дальнейшие правки - по необходимости
Так как нет CI/CD некоторые вещи требуют отдельного запуска команд CLI. Команды ниже нужно запускать в следующих
случаях:
- установить новые пакеты композера ```prod-composer-install``` - устанавливает из composer.lock, поэтому 
и не только поэтому этот файл должен быть в гите.
- затянуть изменения БД из миграций ```make prod-migrate``` - заодно сбрасывает кэш приложения
- пересобрать ассеты для фронта -```make prod-yarn-build```
- можно все эти комманды запустить последовательно с помощью ```make prod-build```. Но не всегда это правильное решение,
так как это долго и не всегда нужен сброс кэша приложения, а без кэша сайт по началу работает медленно.
